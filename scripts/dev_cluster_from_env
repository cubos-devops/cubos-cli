#!/bin/bash
set -e

SERVER_NAME=cubos-dev
SERVER_URL=https://35.190.148.237
SERVER_CA=LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURERENDQWZTZ0F3SUJBZ0lSQVBUN3RzNkRjWGg5L0VvSkw0eDBqYVV3RFFZSktvWklodmNOQVFFTEJRQXcKTHpFdE1Dc0dBMVVFQXhNa1lqSTFNbU0yTldVdFpUQTNOUzAwWWpsakxUa3dZell0TURaaFpEWXpNRGd3TkRaaApNQjRYRFRJd01EWXlPREU1TlRNek9Gb1hEVEkxTURZeU56SXdOVE16T0Zvd0x6RXRNQ3NHQTFVRUF4TWtZakkxCk1tTTJOV1V0WlRBM05TMDBZamxqTFRrd1l6WXRNRFpoWkRZek1EZ3dORFpoTUlJQklqQU5CZ2txaGtpRzl3MEIKQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBdkg1bHVIdlc4MnRzYzRUSHhEdkgxdzd6RFBXWUFsZ25zTjZkMGoxKwprK3p5Qm9YU01sUnV5SlN2endLUGZxU3hHVC9pZUhJb2hLTlRYbGpSOW1SWkZuWVBONm96TFUvRXBrS3dnWmFVCnNPa0NGK29VRmRvd0QzeXFndUw3enBCdEkyUjV1b2Q5eWZrZzNvazJBeHIwUzdIU2ZJeWxDT0J1cWl5bUQzeEYKUEVZN0NlMXhSWEhnMUNBQ3pzZkNpN2lRejJjQzY3UE8zVm55cGtNNG92cUdhdjQ2WjBmMUtiOXg4TC9IUjNSbAp3NjhHMStkYU9VQ0gzeVZtS1V2NjZkbzEwL3ZLQTM1aGZiNEZoZS9WL2N5R0cremFHZ0RabFJTR080eWVNZlBCClVueDZZVXRTTVFqdHFwNTVVNmduQXhRa05kUUxUWVY1ejJoeDQ1OEJxaXBjZVFJREFRQUJveU13SVRBT0JnTlYKSFE4QkFmOEVCQU1DQWdRd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBTkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQQphU0lQb3RWUHdqR1NVOTRwbjZ0ckx5bUxDS0hIbCtYditiVWNmWjAyRStMY3dnYUJqUSsrcXd0MEhxVXBQTENhCnlRaUxielFZY2RzSFVxRGZnRjlLTjlxbVBheFNKSHFSRFZ6dHB3NXA1UHdGR3ZKaTNPckxlQ2JCN2d1WmxmWVYKMHdjSUV5SnFvbFN2L2laTnRPQjBCdGgyUGxVNHRPdTgyemRaZUtlalErcTd0RStxRmpoV0hybFJxNkdaeC96QQpNMUUvTTNKaC9qTEFubkVOZmRqckUzVVhUNk1QQXlTQjBoUnQwY09XYkg0ZW5PYTdKZXJkNGl5M1hJQ0hrUllqCnlmaGRGZ2F1MDhna0tUTVFneWRtc1cyZFBDWC9kMDBkVFdhTEZYTHlWSmhtdHlLN1RLSXJKSGRxYXdXbEJXS08KbE5yajNwa3Flc2FRMmlTeDZQSElHdz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0g
TOKEN_VAR_NAME="${1}_GKE"

if [ -z "${!TOKEN_VAR_NAME}" ]; then
  TOKEN_VAR_NAME="${1}"
fi

TOKEN="${!TOKEN_VAR_NAME}"

if [ -z "${!1}" ]; then
  echo -e "\e[1m\e[91mâ›” The environment variable '${1}' is missing. Did you forget to set it? Check out Settings / Secrets / Actions / Repository Secrets\e[0m"
  exit 1
fi

kubectl config set-cluster "${SERVER_NAME}" --server="${SERVER_URL}"
kubectl config set clusters."${SERVER_NAME}".certificate-authority-data "${SERVER_CA}"
kubectl config set-credentials ci --token="${TOKEN}"
kubectl config set-context "${SERVER_NAME}"-deploy --cluster="${SERVER_NAME}" --user=ci
kubectl config use-context "${SERVER_NAME}"-deploy
